<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Saviynt Query Assist</title>

  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="./libs/codemirror.min.css">
  <!-- Lint and hint CSS -->
  <link rel="stylesheet" href="./libs/lint.min.css">
  <link rel="stylesheet" href="./libs/show-hint.min.css">
  <link rel="stylesheet" href="./libs/dracula.css">
  <script type="text/javascript" src="libs/schema.js"></script>
  <!-- Optional: SQL Formatter library for 'Beautify' -->
  <script src="./libs/sql-formatter.min.js.download"></script>
  
  <style>
    /* Global deep navy background and font settings */
    body {
      margin: 0;
      padding: 0;
      background-color:rgb(13, 14, 66); /* Deep navy blue */
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #ffffff;
    }

    /* A container to center our editor and controls */
    .container {
      width: 90%;
      margin: 2rem auto;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }

    /* CodeMirror styling: override default background/text to fit navy theme */
    .CodeMirror {
      height: 75vh;
      border: 1px solid #444;
      background-color: #ffffff; /* same deep navy */
      color: #000000;
      font-size: 14px;
    }

    /* Lint markers inside the editor */
    .CodeMirror-lint-marker-error {
      color: #ff5c5c; /* red for errors */
    }
    
    /* Buttons row */
    .buttons {
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    button {
      cursor: pointer;
      background-color: #1f4068;
      border: none;
      color: #fff;
      padding: 0.6rem 1.2rem;
      font-size: 14px;
      border-radius: 4px;
    }

    button:hover {
      background-color: #162447;
    }
    
  </style>
</head>
<body>
  <div class="container">
    <!-- Buttons for formatting and minifying -->
    <div class="buttons">
      <button id="beautifyBtn">Beautify SQL</button>
      <button id="minifyBtn">Minify SQL</button>
    </div>

    <!-- The editor container -->
    <textarea id="sqlEditor" name="sqlEditor" style="display: none;"></textarea><div class="CodeMirror cm-s-default" hidden translate="no"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 5px; left: 51px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; min-height: 1em; outline: none;" aria-autocomplete="list"></textarea></div><div class="CodeMirror-vscrollbar" tabindex="-1" cm-not-content="true"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-hscrollbar" tabindex="-1" cm-not-content="true" style="right: 0px; left: 46px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 46px; margin-bottom: -17px; border-right-width: 33px; min-height: 25px; min-width: 7px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre class="CodeMirror-line-like">x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-cursors" style="visibility: hidden;"><div class="CodeMirror-cursor" style="left: 4px; top: 0px; height: 17px;">&nbsp;</div></div><div class="CodeMirror-code" role="presentation"><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" aria-hidden="true" style="left: -46px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 16px; width: 21px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">â€‹</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 33px; width: 1px; border-bottom: 0px solid transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="height: 58px; left: 0px;"><div class="CodeMirror-gutter CodeMirror-lint-markers"></div><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div>
  </div>

  <!-- CodeMirror JS -->
  <script src="./libs/codemirror.min.js.download"></script>
  <!-- SQL mode -->
  <script src="./libs/sql.min.js.download"></script>
  <!-- Hints for autocomplete -->
  <script src="./libs/show-hint.min.js.download"></script>
  <script src="./libs/sql-hint.min.js.download"></script>

  <script>
    const columnsData = TableSchema;
    // Build an object in the format CodeMirror expects for SQL auto-hint:
    // {
    // "tableName": ["col1", "col2", ...],
    // ...
    // }
    const tablesForHint = {};
    columnsData.forEach(item => {
      const tableName = item.Table;
      const columnName = item.Column;
      if (!tablesForHint[tableName]) {
        tablesForHint[tableName] = [];
      }
      tablesForHint[tableName].push(columnName);
    });

    // Initialize CodeMirror
    const sqlEditor = CodeMirror.fromTextArea(document.getElementById("sqlEditor"), {
      mode: "text/x-mysql", // or "text/x-sql"
      theme: "dracula", // We'll override the background in CSS
      lineNumbers: false,
      styleActiveLine: true,
      matchBrackets: true,      
      gutters: ["CodeMirror-lint-markers"],
      // Enable auto-hint
      extraKeys: {
        "Ctrl-Space": "autocomplete"
      },
      hintOptions: {
        tables: tablesForHint
      }
    });

    // Beautify button
    document.getElementById("beautifyBtn").addEventListener("click", () => {
      const currentQuery = sqlEditor.getValue();
      const formatted = sqlFormatter.format(currentQuery, {
        language: "sql" // or 'mysql' if you prefer
      });
      sqlEditor.setValue(formatted);
    });

    // Minify button
    document.getElementById("minifyBtn").addEventListener("click", () => {
      // A simple approach to minifying: remove extra whitespace and newlines
      const currentQuery = sqlEditor.getValue();
      // Very naive minify: condense multiple spaces to one, remove line breaks
      const minified = currentQuery
        .replace(/\s+/g, " ")
        .replace(/\n+/g, " ")
        .trim();
      sqlEditor.setValue(minified);
    });
  </script>

</body></html>
